### client

gkfs_functions.cpp：实现 GekkoFS 版本的文件操作函数，本质上是一个中间层，将客户端的I/O操作通过RPC转发到守护进程处理。

执行某些系统调用时需要数据和元数据同步更新，如 truncate 、write。

struct dirent 结构体用于表示一个目录项

gkfs_libc.cpp：实现对 libc 库函数的拦截和转发逻辑。使用 LD_PRELOAD 环境变量，将原 libc 函数替换为该源文件中自定义的同名函数，对于 GekkoFS 管理范围内的文件操作，调用 gkfs_functions.cpp 中定义的实际操作函数；否则调用 dlsym_func ，而 dlsym_func 则最终调用真正的 libc 库函数。封装得有点深。

hooks.cpp：实现了各种 POSIX 系统调用的钩子函数，在 intercept.cpp 中被调用。

intercept.cpp：通过 system call intercepting library 实现系统调用拦截，需要区分来自应用程序的系统调用（传递到内核或者转发到守护进程）和 GekkoFS 库自身产生的系统调用（传递到内核进行处理并对该操作产生的内部文件描述符进行跟踪）。

malleability.cpp：执行节点扩展操作，将对应的 RPC 消息转发到守护进程处理。

open_dir.cpp & open_file_map.cpp：实现 filemap 相关类的函数，对打开的文件和目录进行管理。

path.cpp：处理路径解析、符号链接跟踪以及当前工作目录的管理。

preload_context.cpp：PreloadContext 类是 GekkoFS 客户端的中央管理器，负责维护所有运行时状态和配置信息。

preload.cpp：作为GekkoFS客户端的入口点，负责在应用程序启动时设置分布式文件系统所需的所有基础设施和服务，包括初始化 hermes 接口、和守护进程建立连接、设置分配策略、是否启用缓存、初始化当前工作目录、启动系统调用拦截等。

### common

arithmetic.cpp：定义了一些位运算工具函数，用于数据分片。

distributor.cpp：定义了一些数据分布器类，包括简单哈希、本地哈希、转发哈希和引导哈希（以目录为粒度分发数据）。

log_util.cpp：GekkoFS 文件系统的日志工具模块实现，基于 spdlog 库提供日志功能的配置和管理。

metadata.cpp：元数据管理模块实现，负责文件和目录的元数据存储、序列化和管理。

msgpack_util.cpp：GekkoFS文件系统的客户端指标收集和消息打包工具模块实现。

path_util.cpp：一些路径处理相关的工具函数。

### daemon

chunk_storage.cpp：ChunkStorage 类处理所有和节点本地存储系统的数据交互，每个守护进程运行着一个实例。本质上是对 libc 库函数的一层包装，在此之上额外对文件进行了分块处理。

data_module.cpp：实现了 DataModule 类，管理与数据相关的日志记录功能。

db.cpp：MetadataDB 类封装了 RocksDB 和 Parallax 的相关 I/O 操作。

merge.cpp：实现了 RocksDB 的 MergeOperator 类的一些接口，用于合并在同一 key 上的增量更新，避免对元数据的频繁访问。对外提供 merge 接口。

metadata_module.cpp：实现了 MetadataModule 类，除了管理与数据相关的日志记录功能以外，还负责管理一些元数据操作时的全局数据结构，如 append 操作的 offset。

parallax_backend.cpp：实现了 ParallaxBackend 类，负责与 Parallax 键值存储系统交互，封装了增删改查操作，对外提供上层接口。

rocksdb_backend.cpp：实现了 RocksDBBackend 类，负责与 RocksDB 键值存储系统交互，封装了增删改查操作，对外提供上层接口。某些操作会延迟执行。

**！！！**在执行 write 操作之前，元数据端需要首先更新文件大小。对于 append 操作，元数据端需要返回数据写入的起始偏移，因此必须强制 merge 此前累计的一系列操作，成本较高。

**？？？**如何保证并发 append 操作的一致性？

元数据节点负责 append 操作的串行化，并返回一个 offset，用于告知客户端写入数据的位置。

**！！！**其中一个文件操作是查找目录 dir 下的所有目录项，实现方式是遍历数据库中所有满足 key 以 dir 为前缀的条目。

GekkoFS 在定义元数据操作相关类时采用了**奇异递归模板模式(**Curiously Recurring Template Pattern，**CRTP**)。CRTP 是 C++ 模板编程时的一种惯用法（idiom），特点为把派生类作为基类的模板参数。

fs_data.cpp：实现 FsData 类。FsData 类负责维护系统运行所需的所有全局信息。（全局变量集合）

rpc_data.cpp：实现 RPCData 类。RPCData 类是 GekkoFS 中负责管理所有 RPC 通信相关资源和配置的核心数据类。（全局变量集合）

srv_data.cpp：实现各类数据操作，接收客户端的数据请求，与客户端通过 RDMA 进行数据传输，并与本地文件系统交互。

srv_malleability.cpp：实现节点的扩展，接收客户端的扩展请求，并调用 MalleableManager 类的相关接口实现数据和元数据的迁移。

srv_management.cpp：直接向客户端返回文件系统的整体元信息。

srv_metadata.cpp：实现各类元数据操作，接收客户端的元数据请求，并与本地文件系统交互。

malleable_manager.cpp：实现 MalleableManager 类，对数据和元数据进行重新分配，需要与其他主机通信。

forward_distribution.cpp：定义了一些工具函数，负责将本地的数据/元数据迁移到其他主机。

data.cpp：实现了多个数据操作的 ChunkOperation 类，向下封装了 ChunkStorage 类的数据操作函数，向上为 srv_data.cpp 中的函数提供接口。使用了Argobots 线程库，每个操作都通过任务队列异步执行，避免阻塞主线程。

metadentry.cpp：向下封装了 MetadataDB 类的元数据操作函数，向上为 srv_metadata.cpp 中的函数提供接口。

daemon.cpp：GekkoFS 的守护进程主程序，负责初始化和管理整个文件系统的服务。
