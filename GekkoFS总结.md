#GekkoFS – A temporary burst buffer file system for HPC applications

## 一、前置知识

（1）LD_PRELOAD、system call intercepting library

LD_PRELOAD：通过 LD_PRELOAD 环境变量指定的动态链接库会被优先加载，随后加载的动态链接库若存在同名函数则会被覆盖。这是客户端拦截的基本原理。
system call intercepting library：系统调用拦截库，在 GekkoFS 的客户端中被使用。使用 hotpatch 技术，在进程地址空间中对 libc 库函数的机器码进行修改，将其中所有的 syscall 指令替换成 jmp 指令，使程序跳转到用户自定义的回调函数处执行，结束后返回断点。

（2）adapter、fabric

adapter：网络适配器（Network Adapter），也叫网卡（NIC），用于连接设备和网络，是物理层和数据链路层之间的接口。

fabric：该词语来源于网络交换机。交换机内部输入输出端口的连接方式之一为开关矩阵，其结构类似于纤维，因此交换机内的架构被称为Switch Fabric。

（3）RDMA、InfiniBand

RDMA：在传统的 TCP/IP 通信中，消息通过内核传递，频繁的协议封装和解封操作造成大量的数据移动和复制开销。对于小规模消息通信，网络传输延迟较小，因此发送端和接收端的处理开销占整个通信开销的主导。

（发送方）用户空间buffer -> 内核空间socket buffer -> 数据封装 -> NIC buffer -> （接收方）socket buffer -> 数据解封 -> 用户空间buffer -> 系统上下文切换

RDMA特点：

+ 内核旁路。应用程序在用户态进行数据传输，无需操作系统参与，减少了上下文切换开销。

+ 零拷贝。数据在用户空间虚拟内存和NIC网卡之间直接进行传输，无需额外的数据移动和复制。

InfiniBand：一种服务器和存储器的互联技术，天然支持RDMA，数据传输无需主机CPU的参与。

## 二、优化点总结

### 客户端

**（1）系统调用拦截**

客户端拦截文件 I/O 有关的系统调用并转发，由守护进程在“用户态”处理应用程序的 I/O 请求。

优点：

+ 通过直接拦截系统调用，缩短了处理路径，避免了传统 FUSE 模型中内核态与用户态之间的频繁切换以及反复的数据拷贝，性能更优。
+ 与直接拦截 libc 库函数相比，只需对底层的系统调用进行拦截和实现，代码量更小。

+ 应用无需修改或重新编译，只需在运行时预加载GekkoFS的库即可。

缺点：

+ 系统调用拦截的具体实现方式和操作系统以及指令集体系结构有关，可移植性差。GekkoFS 所使用的 syscall_intercept 库仅支持 linux 系统 + x86_64 架构。
+ 依赖于环境变量 LD_PRELOAD，每次运行程序时需手动设置，且 LD_PRELOAD 的使用本身也存在一定风险。

### 服务端

**（1）宽条带化**

客户端根据路径哈希决定数据的存储位置，将数据和元数据均匀分散在所有节点。

对应负载特征：**小规模I/O、非连续和随机访问模式**

优点：

+ 去中心化架构，无须担心单点故障或元数据服务器的性能瓶颈。
+ 对数据和元数据进行细粒度划分，有助于负载均衡，可扩展性强。
+ 多个**小规模I/O请求**若被转发到不同的守护进程，可被并行处理。

缺点：

+ 和中心化架构相比，缺乏系统的全局视图，不便于数据的统一管理。收集某些信息可能需要与所有节点分别通信，如 chunk 总数。

+ 和基于子树的粗粒度划分相比，细粒度划分会降低元数据的空间局部性。

+ 重命名或移动操作会导致数据迁移，开销较大。

**（2）命名空间扁平化**

放弃传统 linux 文件系统的树型目录结构，取消目录块、inode 等数据结构，将元数据以键值对的形式保存在后端的 KV 数据库中，文件路径作为 key，文件元数据作为 value。

对应负载特征：**大量元数据操作**

优点：

+ 大量的元数据操作可以并发执行，无需分布式锁，典型场景：多个进程在单个目录中创建大量文件。

缺点：

+ 灵活性较差，目录的移动或重命名会造成其内部文件路径的递归修改。
+ 在树型目录结构中，文件查找需要从目录树的根节点向下搜索，耗时和文件所处层数有关；扁平目录结构中，文件查找需要遍历所有键值对，耗时和文件总数有关，在文件数量较大的情况下会比较耗时。

**（3）数据流水化落盘**

服务器在成功接收一个 chunk 后，会启动一个相应的异步写盘任务，主线程不受阻塞，立即开始下一个 chunk 的传输。**数据传输和磁盘 I/O 并行执行**，提高了执行效率。

对应负载特征：**规模较大，涉及每个守护进程上的多个 chunk 的 I/O 请求**

### 网络通信

**（1）RDMA 数据传输**

利用 RDMA 技术，实现客户机和服务器之间的高效数据传输。RDMA 通过建立内核旁路和零拷贝，减少了上下文切换开销，避免了额外的数据移动和复制。

### 其他

**（1）POSIX 语义松弛**

取消全局锁，以牺牲部分一致性为代价，换取性能提升。对于单文件访问操作（如 read、write、create）可保证强一致性（应用程序保证无共享访问冲突），对于某些目录操作（如 readdir）则遵循最终一致性模型。

取消 Cache，避免同步开销，保持系统简洁设计。

取消对 HPC 场景中不常见的文件操作的优化，如 rename 和 move。

（取消 Cache）**对应负载特征：数据同步**

优点：

+ 取消全局锁，提高数据和元数据操作的并发度。

+ 所以操作均为同步，避免了维持缓存一致导致的大量通信开销，同时也可降低文件系统设计的复杂度。

缺点：

+ 由于缺乏全局锁的保护，对于涉及到的对象数目未知的操作，如 readdir，GekkoFS 可能无法返回目录的当前状态（遵循最终一致性模型）。

+ Cache 可能会带来性能的提升。在没有 Cache 的情况下，当大量的进程写入同一个文件时，GekkkoFS 需要频繁地同步更新其元数据条目。客户端向元数据节点发送的大量 RPC 消息会造成网络拥塞，进一步导致写操作的 IOPS 下降。
